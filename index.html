<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hacker News Live Cloud</title>
    <style>
        :root {
            /* Default Matrix Theme Variables */
            --bg-color: #000000;
            --text-color: #00ff41; /* Cyberpunk Green */
            --highlight: #ccffcc;
            --dim-text: #003b00;
            --link-hover: #ffffff;
            --shadow-color: rgba(0, 255, 65, 0.5);
            --hot-shadow: rgba(0, 255, 65, 0.5);
        }

        /* Vaporwave Theme Overrides */
        body.theme-vaporwave {
            --bg-color: transparent; 
            --text-color: #002b36; /* Solarized Base03 (Dark Grey/Teal) */
            --highlight: #002b36; /* Changed from Yellow to match text-color */
            --dim-text: #002b36;   /* Unified grey */
            --link-hover: #dc322f; /* Solarized Red */
            --shadow-color: rgba(255, 255, 255, 0.6); /* White glow for contrast on dark bg */
            --hot-shadow: rgba(255, 255, 255, 0.8);
            
            /* Moving Gradient Background */
            background: linear-gradient(270deg, #6c71c4, #ff71ce, #2aa198, #01cdfe);
            background-size: 800% 800%;
            /* Superslow animation */
            animation: vaporFlow 120s ease infinite;
        }

        /* Remove background box for Vaporwave theme items */
        body.theme-vaporwave .cloud-item {
            background: transparent;
            /* White halo to ensure dark grey text is visible on dark gradient spots */
            text-shadow: 0 0 5px rgba(238, 232, 213, 0.8); 
            font-weight: 600; /* Slightly bolder for legibility */
        }

        @keyframes vaporFlow {
            0%{background-position:0% 50%}
            50%{background-position:100% 50%}
            100%{background-position:0% 50%}
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            background-color: var(--bg-color);
            font-family: 'Courier New', Courier, monospace;
            transition: background-color 0.5s ease;
        }

        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 8px 15px;
            box-sizing: border-box;
            background: rgba(0, 0, 0, 0.9);
            color: var(--text-color);
            font-size: 12px;
            z-index: 1000;
            border-top: 1px solid var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            transition: border-color 0.5s ease, color 0.5s ease;
        }

        /* Status bar override for vaporwave to match solarized dark */
        body.theme-vaporwave #status-bar {
            background: #002b36; /* Solarized Base03 */
            color: #839496;      /* Solarized Base0 */
            border-top: 1px solid #586e75;
        }

        select#theme-select {
            background: #000;
            color: #00ff41;
            border: 1px solid #00ff41;
            font-family: 'Courier New', Courier, monospace;
            padding: 2px 5px;
            font-size: 11px;
            cursor: pointer;
            outline: none;
            text-transform: uppercase;
        }

        body.theme-vaporwave select#theme-select {
            background: #073642; /* Solarized Base02 */
            color: #93a1a1;      /* Solarized Base1 */
            border: 1px solid #586e75;
        }

        /* Matrix Background Canvas */
        #matrix-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none; 
            transition: opacity 0.5s ease;
        }

        /* Word Cloud Container */
        #canvas {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: 1; 
        }

        .cloud-item {
            position: absolute;
            text-decoration: none;
            color: var(--text-color);
            line-height: 1.1;
            white-space: nowrap;
            transition: left 0.8s ease-in-out, top 0.8s ease-in-out, opacity 0.5s ease, color 0.5s ease, text-shadow 0.5s ease;
            opacity: 0; 
            cursor: pointer;
            z-index: 10;
            padding: 2px 5px;
            border-radius: 2px;
            background: rgba(0,0,0,0.6); 
            text-shadow: 0 0 4px var(--shadow-color);
        }

        .cloud-item:hover {
            color: #000;
            background: var(--text-color);
            z-index: 100;
            box-shadow: 0 0 15px var(--text-color);
            transition: none; 
        }

        body.theme-vaporwave .cloud-item:hover {
            color: #fdf6e3; /* Solarized Base3 (Light) */
            background: #002b36; /* Dark background on hover */
            box-shadow: 0 0 15px #2aa198;
        }

        .cloud-item.hot {
            color: var(--highlight);
            font-weight: bold;
            text-shadow: 0 0 8px var(--hot-shadow);
        }

        .loader {
            display: inline-block;
            width: 10px;
            height: 10px;
            border: 2px solid var(--text-color);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            transition: border-color 0.5s ease;
        }
        
        body.theme-vaporwave .loader {
            border-color: #93a1a1;
            border-top-color: transparent;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <canvas id="matrix-bg"></canvas>
    <div id="canvas"></div>

    <div id="status-bar">
        <div style="display:flex; align-items:center;">
            <div id="spinner" class="loader"></div>
            <span id="status-text">Connecting to HN...</span>
        </div>
        <div style="display:flex; align-items:center; gap: 15px;">
            <div id="count">Items: 0</div>
            <select id="theme-select" onchange="changeTheme(this.value)">
                <option value="vaporwave" selected>Vaporwave Solarized</option>
                <option value="matrix">Matrix</option>
            </select>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const HN_API_BASE = 'https://hacker-news.firebaseio.com/v0';
        const UPDATE_INTERVAL_MS = 10000; 
        const INITIAL_FETCH_COUNT = 30; 
        const TOP_STORIES_LIMIT = 30;
        const MAX_ITEMS = 150; 
        const GLITCH_CHARS = '!<>-_\\/[]{}—=+*^?#01';

        // --- State ---
        const state = {
            seenIds: new Set(),
            stories: [], // Ordered list
            isFetching: false,
            theme: 'vaporwave' // Default to Vaporwave
        };

        const canvas = document.getElementById('canvas');
        const matrixCanvas = document.getElementById('matrix-bg');
        const statusText = document.getElementById('status-text');
        const countText = document.getElementById('count');
        const spinner = document.getElementById('spinner');

        // --- Theme Logic ---
        function changeTheme(themeName) {
            state.theme = themeName;
            const selectEl = document.getElementById('theme-select');
            selectEl.value = themeName;

            if (themeName === 'vaporwave') {
                document.body.classList.add('theme-vaporwave');
                matrixCanvas.style.opacity = '0'; // Hide matrix rain
            } else {
                document.body.classList.remove('theme-vaporwave');
                matrixCanvas.style.opacity = '1'; // Show matrix rain
            }
        }

        // --- Matrix Background Logic ---
        function initMatrix() {
            const c = document.getElementById("matrix-bg");
            const ctx = c.getContext("2d");

            c.width = window.innerWidth;
            c.height = window.innerHeight;

            const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズブヅプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
            const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const chars = (katakana + latin).split("");

            const fontSize = 14;
            const columns = c.width / fontSize;
            
            const drops = [];
            for (let x = 0; x < columns; x++) drops[x] = 1; 

            function drawMatrix() {
                // Optimization: Don't draw if hidden
                if (state.theme !== 'matrix') return;

                ctx.fillStyle = "rgba(0, 0, 0, 0.05)";
                ctx.fillRect(0, 0, c.width, c.height);

                ctx.fillStyle = "#004400"; 
                ctx.font = fontSize + "px monospace";

                for (let i = 0; i < drops.length; i++) {
                    const text = chars[Math.floor(Math.random() * chars.length)];
                    ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                    if (drops[i] * fontSize > c.height && Math.random() > 0.975)
                        drops[i] = 0;

                    drops[i]++;
                }
            }

            setInterval(drawMatrix, 120);

            window.addEventListener('resize', () => {
                c.width = window.innerWidth;
                c.height = window.innerHeight;
                const newCols = c.width / fontSize;
                for (let x = 0; x < newCols; x++) {
                    if (!drops[x]) drops[x] = Math.floor(Math.random() * c.height/fontSize); 
                }
            });
        }

        // --- DOM & Visuals ---

        function calculateFontSize(score) {
            const base = 14;
            const maxAdd = 24;
            const cappedScore = Math.min(score, 600);
            const size = base + (Math.log(cappedScore + 1) / Math.log(601) * maxAdd);
            return Math.floor(size);
        }

        function createWordElement(story) {
            const el = document.createElement('a');
            el.href = `https://news.ycombinator.com/item?id=${story.id}`;
            el.target = "_blank";
            el.className = 'cloud-item';
            el.textContent = story.title;
            el.dataset.original = story.title;
            el.dataset.id = story.id;
            el.id = `story-${story.id}`;

            const fontSize = calculateFontSize(story.score);
            el.style.fontSize = `${fontSize}px`;
            
            if (story.score > 100) el.classList.add('hot');

            el.style.visibility = 'hidden';
            canvas.appendChild(el);
            return el;
        }

        // --- Glitch Effect ---
        function runGlitch() {
            const visibleItems = state.stories
                .map(s => document.getElementById(`story-${s.id}`))
                .filter(el => el && el.style.opacity === '1');

            if (visibleItems.length === 0) return;

            const glitchCount = Math.floor(Math.random() * 4) + 2;
            
            for (let i = 0; i < glitchCount; i++) {
                const el = visibleItems[Math.floor(Math.random() * visibleItems.length)];
                if (!el || el.dataset.glitching) continue;

                el.dataset.glitching = "true";
                const originalText = el.dataset.original;
                const len = originalText.length;
                
                const flips = Math.max(1, Math.floor(len * 0.5));
                
                let newText = originalText.split('');
                const indicesToFlip = new Set();
                while (indicesToFlip.size < flips) {
                    indicesToFlip.add(Math.floor(Math.random() * len));
                }

                indicesToFlip.forEach(idx => {
                    if (newText[idx] !== ' ') {
                        newText[idx] = GLITCH_CHARS[Math.floor(Math.random() * GLITCH_CHARS.length)];
                    }
                });
                
                el.textContent = newText.join('');
                
                setTimeout(() => {
                    if (el) {
                        el.textContent = originalText;
                        delete el.dataset.glitching;
                    }
                }, 100 + Math.random() * 150);
            }
        }

        // --- Core Logic: Relayout ---
        
        function relayout() {
            let currentY = 60; // Start below header margin
            
            state.stories.forEach((story) => {
                let el = document.getElementById(`story-${story.id}`);
                
                if (!el) {
                    el = createWordElement(story);
                }

                const width = el.offsetWidth;
                const height = el.offsetHeight;

                if (currentY + height < window.innerHeight) {
                    const minX = 20;
                    const maxX = Math.max(minX, window.innerWidth - width - 20);
                    const safeMaxX = Math.max(minX, maxX);
                    const x = Math.floor(Math.random() * (safeMaxX - minX + 1)) + minX;

                    el.style.left = `${x}px`;
                    el.style.top = `${currentY}px`;
                    el.style.visibility = 'visible';
                    el.style.opacity = 1;
                    
                    currentY += height + 8; 
                } else {
                    el.style.opacity = 0; 
                }
            });
        }

        // --- API & Data Management ---

        async function fetchItem(id) {
            try {
                const resp = await fetch(`${HN_API_BASE}/item/${id}.json`);
                return await resp.json();
            } catch (e) {
                return null;
            }
        }

        async function fetchTopStories() {
            if (state.isFetching) return;
            state.isFetching = true;
            spinner.style.display = 'inline-block';
            
            const isFirstRun = state.stories.length === 0;
            const limit = isFirstRun ? INITIAL_FETCH_COUNT : TOP_STORIES_LIMIT;

            statusText.innerText = `Scanning Top ${limit}...`;
            
            try {
                const resp = await fetch(`${HN_API_BASE}/topstories.json`);
                const allIds = await resp.json();
                const targetIds = allIds.slice(0, limit);
                const newIds = targetIds.filter(id => !state.seenIds.has(id));
                
                if (newIds.length > 0) {
                    statusText.innerText = `Found ${newIds.length} new items...`;
                    
                    const newStories = [];
                    for (const id of newIds) {
                        const story = await fetchItem(id);
                        if (story && !story.deleted && !story.dead) {
                            state.seenIds.add(id);
                            newStories.push(story);
                        }
                    }

                    if (newStories.length > 0) {
                        state.stories = [...state.stories, ...newStories];
                        // Time Sort
                        state.stories.sort((a, b) => b.time - a.time);
                        
                        if (state.stories.length > MAX_ITEMS) {
                            const removed = state.stories.splice(MAX_ITEMS);
                            removed.forEach(s => {
                                const el = document.getElementById(`story-${s.id}`);
                                if (el) el.remove();
                                state.seenIds.delete(s.id);
                            });
                        }

                        relayout();
                        countText.innerText = `Items: ${state.stories.length}`;
                    }
                } else {
                    statusText.innerText = `Monitoring Top ${limit}...`;
                }
                
            } catch (e) {
                console.error(e);
                statusText.innerText = "Connection error.";
            } finally {
                state.isFetching = false;
                spinner.style.display = 'none';
                setTimeout(() => {
                    if (!state.isFetching) statusText.innerText = "Live / Waiting...";
                }, 2000);
            }
        }

        function init() {
            initMatrix(); 
            // Apply default theme
            changeTheme(state.theme);
            
            fetchTopStories();
            setInterval(fetchTopStories, UPDATE_INTERVAL_MS);
            setInterval(runGlitch, 3000); 
            
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(relayout, 500);
            });
        }

        init();

    </script>
</body>
</html>
